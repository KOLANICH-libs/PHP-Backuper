<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1-20130402"/>
<title>Backuper: FileTreeBackuper.php Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Backuper
   &#160;<span id="projectnumber">0.9.2</span>
   </div>
   <div id="projectbrief">PHP Backuping framework</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1-20130402 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d3/d52/a00023_source.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">FileTreeBackuper.php</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;&lt;?php</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">TODO:</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">make root state be stored in base and arrays</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00009"></a><span class="lineno"><a class="code" href="../../d7/dd4/a00013.html">    9</a></span>&#160;<span class="keyword">interface </span><a class="code" href="../../d7/dd4/a00013.html" title="an interface representing a node of file tree with some basic folder functionality such as hashing...">IFileTreeItem</a>{</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;   <span class="keyword">function</span> hash();</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;   <span class="keyword">function</span> process();</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;   <span class="comment">//public $inode,$mtime,$ctime,$size,$uid;</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;};</div>
<div class="line"><a name="l00017"></a><span class="lineno"><a class="code" href="../../df/d86/a00012.html">   17</a></span>&#160;<span class="keyword">interface </span><a class="code" href="../../df/d86/a00012.html" title="an interface representing a folder with some basic folder functionality such as expanding children...">IFileTreeDir</a> <span class="keyword">extends</span> <a class="code" href="../../d7/dd4/a00013.html" title="an interface representing a node of file tree with some basic folder functionality such as hashing...">IFileTreeItem</a>{</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;   <span class="keyword">function</span> processChild(<a class="code" href="../../d7/dd4/a00013.html" title="an interface representing a node of file tree with some basic folder functionality such as hashing...">IFileTreeItem</a> &amp;$fChild);</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;   <span class="keyword">function</span> expandChildren();</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;};</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="keyword">function</span> convertNodeFromBase(&amp;$row){</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;   $row-&gt;inode=(integer)$row-&gt;inode;</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;   $row-&gt;parent=(integer)$row-&gt;parent;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;   $row-&gt;hash=(integer)$row-&gt;hash;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;   $row-&gt;pathhash=(integer)$row-&gt;pathhash;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;}</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div>
<div class="line"><a name="l00033"></a><span class="lineno"><a class="code" href="../../de/d5e/a00007.html">   33</a></span>&#160;<span class="keyword">class </span><a class="code" href="../../de/d5e/a00007.html">FileTreeBackuperIndex</a> <span class="keyword">extends</span> <a class="code" href="../../d7/d46/a00002.html" title="A class for mantaining index.">BackuperIndex</a>{</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;   <span class="keyword">public</span> $base=null;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;   <span class="comment">//index</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;   <span class="comment">//patch to current state</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;   <span class="keyword">const</span> indexPrefix=<span class="stringliteral">&quot;FileTreeBackuper_&quot;</span>;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;   <span class="keyword">public</span> $moved=array(),$deleted=array(),$changed=array(),$added=array();</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;   <span class="comment">//public $modified=array();</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;   <span class="keyword">public</span> $ignores=array();</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;   <span class="keyword">static</span> $queriesTemplates=array(</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;      <span class="stringliteral">&quot;getTree&quot;</span>=&gt;<span class="stringliteral">&#39;SELECT * FROM `%PR%fileTree`;&#39;</span>,</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;      <span class="stringliteral">&quot;getChildren&quot;</span>=&gt;<span class="stringliteral">&quot;SELECT * FROM `%PR%fileTree` where `parent`=?;&quot;</span>,</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;      <span class="stringliteral">&quot;getIgnores&quot;</span>=&gt;<span class="stringliteral">&quot;SELECT * FROM `%PR%ignores`;&quot;</span>,</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;      <span class="stringliteral">&quot;upsertFileToTree&quot;</span>=&gt;<span class="stringliteral">&quot;INSERT INTO `%PR%fileTree` VALUES (:inode, :parent, :hash, :pathhash, :name);&quot;</span>,</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;      <span class="stringliteral">&quot;deleteFileFromTree&quot;</span>=&gt;<span class="stringliteral">&quot;DELETE FROM `%PR%fileTree` WHERE `inode`=:inode;&quot;</span>,</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;      <span class="stringliteral">&quot;addCommit&quot;</span>=&gt;<span class="stringliteral">&quot;INSERT INTO `%PR%commits` (`timestamp`) VALUES (:time);&quot;</span>,</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;      <span class="stringliteral">&quot;addFileToMoved&quot;</span>=&gt;<span class="stringliteral">&quot;INSERT INTO `%PR%movedCurrent` VALUES (:inode,:prevParent);&quot;</span>,</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;      <span class="stringliteral">&quot;addFileToDeleted&quot;</span>=&gt;<span class="stringliteral">&quot;INSERT INTO `%PR%deletedCurrent` VALUES (:name,:parent);&quot;</span>,</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;   );</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;   </div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;   <span class="keyword">static</span> $baseStructureBuildQuery=array(</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;      <span class="stringliteral">&#39;fileTree&#39;</span>=&gt;<span class="stringliteral">&#39;</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="stringliteral">         &quot;inode&quot;  INTEGER NOT NULL,</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="stringliteral">         &quot;parent&quot;  INTEGER NOT NULL,</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="stringliteral">         &quot;hash&quot;  INTEGER NOT NULL,</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="stringliteral">         &quot;pathhash&quot;  INTEGER NOT NULL,</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="stringliteral">         &quot;name&quot;  VARCHAR(256) NOT NULL,</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="stringliteral">         PRIMARY KEY (&quot;inode&quot;) ON CONFLICT REPLACE,</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="stringliteral">         FOREIGN KEY (&quot;parent&quot;) REFERENCES &quot;%PR%fileTree&quot; (&quot;inode&quot;)</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="stringliteral">         UNIQUE (&quot;inode&quot;) ON CONFLICT REPLACE,</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="stringliteral">         UNIQUE (&quot;hash&quot;) ON CONFLICT REPLACE,</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="stringliteral">         UNIQUE (&quot;pathhash&quot;) ON CONFLICT REPLACE&#39;</span>,</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;      <span class="stringliteral">&#39;ignores&#39;</span>=&gt;<span class="stringliteral">&#39;&quot;ignore&quot;  varchar(512) NOT NULL&#39;</span>,</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;      <span class="stringliteral">&#39;commits&#39;</span>=&gt;<span class="stringliteral">&#39;</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="stringliteral">         &quot;id&quot;  integer PRIMARY KEY AUTOINCREMENT NOT NULL,</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="stringliteral">         &quot;timestamp&quot;  TIMESTAMP NOT NULL&#39;</span>,</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;      <span class="stringliteral">&#39;movedCurrent&#39;</span>=&gt;<span class="stringliteral">&#39;</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="stringliteral">         &quot;inode&quot;  integer PRIMARY KEY AUTOINCREMENT NOT NULL,</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="stringliteral">         &quot;prevParent&quot;  integer NOT NULL,</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="stringliteral">         FOREIGN KEY (&quot;prevParent&quot;) REFERENCES &quot;%PR%fileTree&quot; (&quot;inode&quot;)&#39;</span>,</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;      <span class="stringliteral">&#39;deletedCurrent&#39;</span>=&gt;<span class="stringliteral">&#39;</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="stringliteral">         &quot;name&quot;  VARCHAR(256) NOT NULL,</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="stringliteral">         &quot;parent&quot;  integer NOT NULL&#39;</span>,</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;   );</div>
<div class="line"><a name="l00079"></a><span class="lineno"><a class="code" href="../../de/d5e/a00007.html#aa86b1784262153642ce8b76fb0233900">   79</a></span>&#160;   <span class="keyword">function</span> <a class="code" href="../../de/d5e/a00007.html#aa86b1784262153642ce8b76fb0233900">__construct</a>(&amp;$base){</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;      parent::__construct($base);</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;      </div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;      $this-&gt;base-&gt;exec(<span class="stringliteral">&#39;delete from `&#39;</span>.static::indexPrefix.<span class="stringliteral">&#39;movedCurrent` where 1;&#39;</span>);</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;      $this-&gt;base-&gt;exec(<span class="stringliteral">&#39;delete from `&#39;</span>.static::indexPrefix.<span class="stringliteral">&#39;deletedCurrent` where 1;&#39;</span>);</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;   }</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;   <span class="keyword">public</span> $inodes=array();</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;   <span class="keyword">function</span> load(){</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;      <span class="comment">//commented out because it could be mo rationally to load on demand</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;      <span class="comment">/*$res=$this-&gt;queries-&gt;getTree-&gt;execute();</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="comment">      new dBug($res);</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="comment">      while($row=$this-&gt;queries-&gt;getChildren-&gt;fetchObject()){</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="comment">         convertNodeFromBase($row);</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="comment">         $this-&gt;inodes[$row-&gt;inode]=$row;// it looks like here I need &amp; (a reference) here but id doesn&#39;t work by unknown reason</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="comment">      }</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="comment">      $this-&gt;queries-&gt;getTree-&gt;closeCursor();*/</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;      $this-&gt;queries-&gt;getIgnores-&gt;execute();</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;      $this-&gt;ignores=$this-&gt;queries-&gt;getIgnores-&gt;fetchAll(PDO::FETCH_COLUMN);</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;      $this-&gt;queries-&gt;getIgnores-&gt;closeCursor();</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;   }</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;   </div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;   <span class="keyword">function</span> checkIsIgnored($path){</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;      <span class="keywordflow">foreach</span>($this-&gt;ignores as $ignoreRule){</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;         <span class="keywordflow">if</span>(preg_match($ignoreRule,$path)){</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;         }</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;      }</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;   }</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;   </div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;   <span class="keyword">function</span> loadChildren(&amp;$parent){</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;      $res=$this-&gt;queries-&gt;getChildren-&gt;execute(array($parent));</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;      $arr=array();</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;      <span class="keywordflow">while</span>($row=$this-&gt;queries-&gt;getChildren-&gt;fetchObject()){</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;         convertNodeFromBase($row);</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;         $this-&gt;inodes[$row-&gt;inode]=&amp;$row;<span class="comment">//it looks like i need &amp; (a reference) here but id doesn&#39;t work by unknown reason</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;         <span class="comment">//$arr[$row-&gt;inode]=&amp;$this-&gt;inodes[$row-&gt;inode];</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;         $arr[$row-&gt;inode]=$this-&gt;inodes[$row-&gt;inode];</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;      }</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;      $this-&gt;queries-&gt;getChildren-&gt;closeCursor();</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;      <span class="keywordflow">return</span> $arr;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;   }</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;   <span class="keyword">function</span> needBackup(){</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;      <span class="keywordflow">return</span> !(empty($this-&gt;added)&amp;&amp;empty($this-&gt;changed)&amp;&amp;empty($this-&gt;deleted)&amp;&amp;empty($this-&gt;moved));</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;   }</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;   <span class="keyword">function</span> save($time=0){</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;      <span class="keywordflow">if</span>(!$this-&gt;needBackup())<span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;      $this-&gt;base-&gt;beginTransaction();</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;      <span class="keywordflow">try</span>{</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;         $this-&gt;makeCommitRecord();</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;         $this-&gt;<a class="code" href="../../de/d5e/a00007.html#a872af2c0a300b8a7fd5d220f3b34866a">saveAdded</a>();</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;         $this-&gt;saveChanged();</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;         $this-&gt;saveMoved();</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;         $this-&gt;saveDeleted();</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;         $this-&gt;base-&gt;commit();</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;      }</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;      <span class="keywordflow">catch</span>(Exception $exc){</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;         $this-&gt;base-&gt;rollBack();</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;         <span class="comment">//$this-&gt;base-&gt;commit();</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;         <span class="keywordflow">throw</span> $exc;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;      }</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;   }</div>
<div class="line"><a name="l00143"></a><span class="lineno"><a class="code" href="../../de/d5e/a00007.html#a872af2c0a300b8a7fd5d220f3b34866a">  143</a></span>&#160;   <span class="keyword">function</span> <a class="code" href="../../de/d5e/a00007.html#a872af2c0a300b8a7fd5d220f3b34866a">saveAdded</a>(){</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;      echo <span class="stringliteral">&quot;saving added....\n&lt;br/&gt;&quot;</span>;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;      <span class="keywordflow">foreach</span>($this-&gt;added as &amp;$node){</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;         <span class="comment">//if you get here error about no disk space it can be REALLY FREE SPACE ON SYSTEM DISK (even though php is installed not to system disk and temp moved to another disk...)</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;         <span class="comment">//try to run ccleaner to make some empty space in system disk</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;         <span class="comment">//new dBug(array(&#39;inode&#39;=&gt;$node-&gt;inode,&#39;parent&#39;=&gt;$node-&gt;parent,&#39;hash&#39;=&gt;$node-&gt;hash,&#39;pathhash&#39;=&gt;$node-&gt;pathhash,&#39;name&#39;=&gt;$node-&gt;name));</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;         $res=$this-&gt;queries-&gt;upsertFileToTree-&gt;execute(array($node-&gt;inode,$node-&gt;parent,$node-&gt;hash,$node-&gt;pathhash,$node-&gt;name));</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;      }</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;   }</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;   <span class="keyword">function</span> saveChanged(){</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;      echo <span class="stringliteral">&quot;saving changed....\n&lt;br/&gt;&quot;</span>;</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;      <span class="keywordflow">foreach</span>($this-&gt;changed as &amp;$node){</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;         $res=$this-&gt;queries-&gt;upsertFileToTree-&gt;execute(array($node-&gt;inode,$node-&gt;parent,$node-&gt;hash,$node-&gt;pathhash,$node-&gt;name));</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;      }</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;   }</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;   <span class="keyword">function</span> saveMoved(){</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;      echo <span class="stringliteral">&quot;saving moved....\n&lt;br/&gt;&quot;</span>;</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;      <span class="keywordflow">foreach</span>($this-&gt;moved as &amp;$node){</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;         $res=$this-&gt;queries-&gt;upsertFileToTree-&gt;execute(array($node-&gt;inode,$node-&gt;parent,$node-&gt;hash,$node-&gt;pathhash,$node-&gt;name));</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;         $res=$this-&gt;queries-&gt;addFileToMoved-&gt;execute(array($node-&gt;inode,$node-&gt;prevParent));</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;      }</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;   }</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;   <span class="keyword">function</span> saveDeleted(){</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;      echo <span class="stringliteral">&quot;removing deleted....\n&lt;br/&gt;&quot;</span>;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;      <span class="keywordflow">foreach</span>($this-&gt;deleted as &amp;$node){</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;         $res=$this-&gt;queries-&gt;deleteFileFromTree-&gt;execute(array($node-&gt;inode));</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;         $res=$this-&gt;queries-&gt;addFileToDeleted-&gt;execute(array($node-&gt;name,$node-&gt;parent));</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;      }</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;   }</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;   <span class="keyword">function</span> makeCommitRecord($time=0){</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;      <span class="keywordflow">if</span>(!$time)$time=time();</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;      $this-&gt;queries-&gt;addCommit-&gt;execute(array($time));</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;      <span class="comment">//$this-&gt;queries-&gt;addCommit-&gt;execute();</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;      <span class="keywordflow">return</span> $time;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;   }</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;};</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div>
<div class="line"><a name="l00184"></a><span class="lineno"><a class="code" href="../../da/da0/a00009.html">  184</a></span>&#160;<span class="keyword">class </span><a class="code" href="../../da/da0/a00009.html" title="a class representing a file (or a folder) with some basic functionality">FileTreeItem</a> <span class="keyword">implements</span> <a class="code" href="../../d7/dd4/a00013.html" title="an interface representing a node of file tree with some basic folder functionality such as hashing...">IFileTreeItem</a>{</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;   <span class="keyword">public</span> $name,$parent,$hash=0,$pathhash=0;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;   <span class="keyword">static</span> $attributesForHashing=array(<span class="stringliteral">&#39;getInode&#39;</span>=&gt;<span class="stringliteral">&#39;inode&#39;</span>,<span class="stringliteral">&#39;getMTime&#39;</span>=&gt;<span class="stringliteral">&#39;mtime&#39;</span>,<span class="stringliteral">&#39;getCTime&#39;</span>=&gt;<span class="stringliteral">&#39;ctime&#39;</span>,<span class="stringliteral">&#39;getSize&#39;</span>=&gt;<span class="stringliteral">&#39;size&#39;</span>,<span class="stringliteral">&#39;getOwner&#39;</span>=&gt;<span class="stringliteral">&#39;uid&#39;</span>);</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;   </div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;   <span class="keyword">function</span> showAtrs(){</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;      $atrs=<span class="keyword">new</span> stdClass;</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;      <span class="keywordflow">foreach</span>(static::$attributesForHashing as $atrName)$atrs-&gt;$atrName=$this-&gt;$atrName;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;      <span class="keyword">new</span> dBug($atrs);</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;   }</div>
<div class="line"><a name="l00193"></a><span class="lineno"><a class="code" href="../../da/da0/a00009.html#a92b25500ce7d73b91a69ba185bb23693">  193</a></span>&#160;   <span class="keyword">function</span> <a class="code" href="../../da/da0/a00009.html#a92b25500ce7d73b91a69ba185bb23693">__construct</a>(RecursiveDirectoryIterator  &amp;$file,<a class="code" href="../../df/d86/a00012.html" title="an interface representing a folder with some basic folder functionality such as expanding children...">IFileTreeDir</a> &amp;$parent=null){</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;      <span class="comment">//echo &quot;the dir is:&quot;.$dir.&quot;\n&quot;;</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;      <span class="comment">//echo &quot;the object path is:&quot;.$dir+&quot;/&quot;+$name.&quot;\n&quot;;</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;      echo <span class="stringliteral">&quot;constructing &quot;</span>.$file-&gt;getPathname().<span class="stringliteral">&quot;&lt;br/&gt;\n&quot;</span>;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;      <span class="keywordflow">if</span>(!$parent)<span class="keywordflow">throw</span> <span class="keyword">new</span> Exception(<span class="stringliteral">&quot;file has no parent. Serious bug!!!&quot;</span>);</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;      $this-&gt;name=$file-&gt;getFilename();</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;      </div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;      </div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;      <span class="keywordflow">foreach</span>(static::$attributesForHashing as $getter=&gt;&amp;$atrName)$this-&gt;$atrName=$file-&gt;$getter();</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;      <span class="comment">//good style and flexibility makes overhead</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;      echo <span class="stringliteral">&quot;size is &quot;</span>.$this-&gt;size.<span class="stringliteral">&quot;&lt;br/&gt;\n&quot;</span>;</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;      <span class="keywordflow">if</span>(!$this-&gt;inode){</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;         $this-&gt;inode=unpack(<span class="charliteral">&#39;L&#39;</span>,md5(</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;            $file-&gt;isDir().</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;            <span class="stringliteral">&quot;|!&quot;</span>.$file-&gt;isLink().</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;            <span class="stringliteral">&quot;|!&quot;</span>.$this-&gt;name.</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;            <span class="stringliteral">&quot;|!&quot;</span>.$this-&gt;ctime.</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;            ($file-&gt;isDir()?<span class="stringliteral">&quot;|!&quot;</span>.$file-&gt;getPathname():</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;               <span class="comment">//&quot;|!&quot;.$this-&gt;mtime.///why had i included it to inode?</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;               <span class="stringliteral">&quot;|!&quot;</span>.$this-&gt;size</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;            )</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;         ,1));</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;         $this-&gt;inode=$this-&gt;inode[1];</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;      }</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;      </div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;      <span class="comment">//$this-&gt;showAtrs();</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;      </div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;      $this-&gt;parent=$parent-&gt;inode;<span class="comment">//it is here because the node may have yourself as parent</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;      $this-&gt;pathhash=crc32($file-&gt;getPathname());</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;      $this-&gt;<a class="code" href="../../da/da0/a00009.html#af5d527ef2a6e3f43563ad4cb15872140" title="function which make hashing (using md5), look at static::$attributesForHashing">hash</a>=$this-&gt;<a class="code" href="../../da/da0/a00009.html#af5d527ef2a6e3f43563ad4cb15872140" title="function which make hashing (using md5), look at static::$attributesForHashing">hash</a>();</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;      unset($file);</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;      $parent-&gt;inodes[$this-&gt;inode]=&amp;$this;</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;      </div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;   }</div>
<div class="line"><a name="l00232"></a><span class="lineno"><a class="code" href="../../da/da0/a00009.html#af5d527ef2a6e3f43563ad4cb15872140">  232</a></span>&#160;   <span class="keyword">function</span> <a class="code" href="../../da/da0/a00009.html#af5d527ef2a6e3f43563ad4cb15872140" title="function which make hashing (using md5), look at static::$attributesForHashing">hash</a>(){</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;      $hh=hash_init( <span class="stringliteral">&quot;md5&quot;</span> );</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;      <span class="keywordflow">foreach</span>(static::$attributesForHashing as $atrName)hash_update($hh,$this-&gt;$atrName);</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;      $h=unpack(<span class="charliteral">&#39;L&#39;</span>,hash_final( $hh ,1));</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;      $this-&gt;<a class="code" href="../../da/da0/a00009.html#af5d527ef2a6e3f43563ad4cb15872140" title="function which make hashing (using md5), look at static::$attributesForHashing">hash</a>=$h[1];</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;      <span class="keywordflow">return</span> $h[1];</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;   }</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;   <span class="comment">/*function __call($name,$args){</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;<span class="comment">      call_user_func_array(array($this-&gt;file,$name),$args)</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<span class="comment">   }*/</span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;   <span class="keyword">function</span> process(){}</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;};</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;</div>
<div class="line"><a name="l00248"></a><span class="lineno"><a class="code" href="../../d4/dee/a00008.html">  248</a></span>&#160;<span class="keyword">class </span><a class="code" href="../../d4/dee/a00008.html" title="a class representing a folder with some basic folder functionality such as expanding children...">FileTreeDir</a> <span class="keyword">extends</span> <a class="code" href="../../da/da0/a00009.html" title="a class representing a file (or a folder) with some basic functionality">FileTreeItem</a> implements <a class="code" href="../../df/d86/a00012.html" title="an interface representing a folder with some basic folder functionality such as expanding children...">IFileTreeDir</a>{</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;   <span class="keyword">protected</span> $childrenIter=null;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;   <span class="keyword">public</span> $children=null;</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;   <span class="keyword">public</span> $path=<span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;   <span class="keyword">function</span> __construct(RecursiveDirectoryIterator  &amp;$file,<a class="code" href="../../df/d86/a00012.html" title="an interface representing a folder with some basic folder functionality such as expanding children...">IFileTreeDir</a> &amp;$parent){</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;      parent::__construct($file,$parent);</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;      $this-&gt;path=$file-&gt;getPathname();</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;      <span class="comment">//new dBug($this-&gt;path);</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;      $this-&gt;childrenIter=$file-&gt;getChildren();</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;   }</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;   <span class="keyword">function</span> process(){</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;      echo <span class="stringliteral">&quot;processing folder $this-&gt;name ({$this-&gt;inode})&lt;br/&gt;\n&quot;</span>;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;      static::expandChildren();</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;   }</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;   <span class="keyword">function</span> expandChildren(){</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;      <span class="keywordflow">foreach</span>($this-&gt;childrenIter as $child){</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;         $fChild=null;</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;         <span class="keywordflow">if</span>($child-&gt;isDir()){</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;            $fChild=<span class="keyword">new</span> <span class="keyword">static</span>($child,$this);</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;         }</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;         <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;            $fChild=<span class="keyword">new</span> <a class="code" href="../../da/da0/a00009.html" title="a class representing a file (or a folder) with some basic functionality">FileTreeItem</a>($child,$this);</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;            <span class="comment">//new dBug($child);</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;         }</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;         static::processChild($fChild);</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;      }</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;   }</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;   <span class="keyword">function</span> processChild(<a class="code" href="../../d7/dd4/a00013.html" title="an interface representing a node of file tree with some basic folder functionality such as hashing...">IFileTreeItem</a> &amp;$fChild){</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;      </div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;   }</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;};</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="keyword">function</span> drawHierarchy(&amp;$inodelist){</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;   $arr=array();</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;   <span class="keywordflow">foreach</span>($inodelist as $inode=&gt;&amp;$file){</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;      <span class="keywordflow">if</span>(empty($arr[$inode])){</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;         $arr[$inode]=array();</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;         $arr[$inode][<span class="stringliteral">&quot;name&quot;</span>]=$file-&gt;name;</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;         $arr[$inode][<span class="stringliteral">&quot;parent&quot;</span>]=$file-&gt;parent;</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;      }</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;   }</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;   $transforms=1;</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;   <span class="keywordflow">while</span>($transforms&gt;0){</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;      $transforms=0;</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;      <span class="keywordflow">foreach</span>($arr as $inode=&gt;&amp;$file){</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;         <span class="keywordflow">if</span>(isset($arr[$file[<span class="stringliteral">&quot;parent&quot;</span>]])){</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;            $arr[$file[<span class="stringliteral">&quot;parent&quot;</span>]][$inode]=&amp;$file;</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;            unset($file[<span class="stringliteral">&quot;parent&quot;</span>]);</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;            $transforms++;</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;         }</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;      }</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;   }</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;   <span class="keywordflow">foreach</span>($arr as $inode=&gt;&amp;$file){</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;      <span class="keywordflow">if</span>(empty($file[<span class="stringliteral">&quot;parent&quot;</span>])){</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;         unset($arr[$inode]);</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;      }</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;   }</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;   <span class="keyword">new</span> dBug($arr);</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;}</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;</div>
<div class="line"><a name="l00316"></a><span class="lineno"><a class="code" href="../../dd/dad/a00005.html">  316</a></span>&#160;<span class="keyword">class </span><a class="code" href="../../dd/dad/a00005.html" title="a class representing a directory with backup functionality not for direct usage">FileTreeBackupDir</a> <span class="keyword">extends</span> <a class="code" href="../../d4/dee/a00008.html" title="a class representing a folder with some basic folder functionality such as expanding children...">FileTreeDir</a>{</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;   <span class="keyword">public</span> $index,$childrenCache;</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;   <span class="keyword">public</span> $root,$relPath;</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;   </div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;   <span class="keyword">function</span> __construct(RecursiveDirectoryIterator  $file,&amp;$parent=null){</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;      <span class="comment">//index is singleton</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;      echo <span class="stringliteral">&quot;&lt;hr/&gt;&quot;</span>;</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;      <span class="keywordflow">if</span>($parent instanceof <a class="code" href="../../de/d21/a00006.html" title="a class representing a plugin for backuping file tree takes array of adresses of roots of the backup...">FileTreeBackuper</a>){</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;         echo <span class="stringliteral">&quot;We are a root of the backup\n&lt;br/&gt;&quot;</span>;</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;         echo <span class="stringliteral">&#39;Root adress is &#39;</span>.$file-&gt;getPathname().<span class="stringliteral">&quot;\n&lt;br/&gt;&quot;</span>;</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;         $this-&gt;index=&amp;$parent-&gt;index;</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;         echo <span class="stringliteral">&quot;now index is of type &quot;</span>.get_class($this-&gt;index).<span class="stringliteral">&quot;\n&lt;br/&gt;&quot;</span>;</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;         parent::__construct($file,$this);<span class="comment">//the root directory is parent of oneself</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;         $this-&gt;root=&amp;$this;</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;         $this-&gt;pathLen=strlen($this-&gt;path);</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;         echo <span class="stringliteral">&quot;root constructed\n&lt;br/&gt;&quot;</span>;</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;      }<span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;         $this-&gt;index=&amp;$parent-&gt;index;</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;         $this-&gt;root=&amp;$parent-&gt;root;</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;         <span class="comment">//$this-&gt;index=&amp;$this-&gt;inodes[$this-&gt;parent]-&gt;index;</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;      </div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;         <span class="comment">//echo &quot;now index is of type &quot;.get_class($this-&gt;index).&quot;\n&lt;br/&gt;&quot;;</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;         parent::__construct($file,$parent);</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;         $this-&gt;relPath=static::getRelPath();</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;      }</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;   }</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;   <span class="keyword">function</span> getRelPath(){<span class="comment">//returns relative path beginning with /</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;      <span class="keywordflow">return</span> substr($this-&gt;path,$this-&gt;root-&gt;pathLen);</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;      <span class="comment">//return (this-&gt;index-&gt;inodes[$this-&gt;parent]-&gt;relPath.&#39;/&#39;.$this-&gt;name);</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;   }</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;   </div>
<div class="line"><a name="l00347"></a><span class="lineno"><a class="code" href="../../dd/dad/a00005.html#af58794c4aa5c24578d0f46468ccb9fd0">  347</a></span>&#160;   <span class="keyword">function</span> <a class="code" href="../../dd/dad/a00005.html#af58794c4aa5c24578d0f46468ccb9fd0">expandChildren</a>(){</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;      $children=$this-&gt;index-&gt;loadChildren($this-&gt;inode);</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;      </div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;      <span class="comment">/*echo &quot;before\n&lt;br/&gt;&quot;;</span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="comment">      new dBug($children);*/</span></div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;      </div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;      <span class="keywordflow">foreach</span>($this-&gt;childrenIter as $child){</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;      </div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;         <span class="keywordflow">if</span>($this-&gt;index-&gt;checkIsIgnored($child-&gt;getFilename())){</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;            echo $child-&gt;getFilename().<span class="stringliteral">&quot; &lt;font color=&#39;purple&#39;&gt;ignored&lt;/font&gt;&lt;br/&gt;\n&quot;</span>;</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;         }</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;         </div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;         <span class="keywordflow">if</span>($child-&gt;isDir()){</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;            $child=<span class="keyword">new</span> <span class="keyword">static</span>($child,$this);</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;         }</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;         <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;            $child=<span class="keyword">new</span> <a class="code" href="../../da/da0/a00009.html" title="a class representing a file (or a folder) with some basic functionality">FileTreeItem</a>($child,$this);</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;            <span class="comment">//new dBug($child);</span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;         }</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;         </div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;         <span class="keywordflow">if</span>(isset($children[$child-&gt;inode])){</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;            echo <span class="stringliteral">&quot;There is element of children with inode {$child-&gt;inode}\n&lt;br/&gt;&quot;</span>;</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;            echo <span class="stringliteral">&quot;hash is &quot;</span>.$child-&gt;hash.<span class="stringliteral">&quot; cached hash is {$children[$child-&gt;inode]-&gt;hash}\n&lt;br/&gt;&quot;</span>;</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;            <span class="comment">//new dBug($this-&gt;index-&gt;inodes[$child-&gt;inode]);</span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;            </div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;            <span class="keywordflow">if</span>($children[$child-&gt;inode]-&gt;hash!=$child-&gt;hash){</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;               <span class="comment">//changed</span></div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;               echo <span class="stringliteral">&quot;file $child-&gt;name was &lt;font color=&#39;orange&#39;&gt;changed&lt;/font&gt;: {$children[$child-&gt;inode]-&gt;hash} != {$child-&gt;hash} \n&lt;br/&gt;\n&quot;</span>;</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;               <span class="comment">//$this-&gt;index-&gt;changed[$child-&gt;inode]=&amp;$child;//TODO:why does the reference cause terrible errors in logic?</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;               $this-&gt;index-&gt;changed[$child-&gt;inode]=$child;</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;            }</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;            <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;               echo <span class="stringliteral">&quot;file $child-&gt;name was &lt;font color=&#39;blue&#39;&gt;not changed&lt;/font&gt; or ????\n&lt;br/&gt;\n&quot;</span>;</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;               <span class="comment">//to prevent processing unchanged</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;               unset($children[$child-&gt;inode]);</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;               <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;            }</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;            unset($children[$child-&gt;inode]);</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;            </div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;         }</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;         <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;            <span class="comment">//added</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;            echo <span class="stringliteral">&quot;file {$child-&gt;name} ({$child-&gt;inode}) was &lt;font color=&#39;green&#39;&gt;added&lt;/font&gt; to folder $this-&gt;name ({$this-&gt;inode})\n&lt;br/&gt;\n&quot;</span>;</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;            <span class="comment">//$this-&gt;index-&gt;added[$child-&gt;inode]=&amp;$child;//TODO:why does the reference cause terrible errors in logic?</span></div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;            $this-&gt;index-&gt;added[$child-&gt;inode]=$child;</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;         }</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;         </div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;         <span class="comment">// put into index an actual object after index was used</span></div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;         $this-&gt;index-&gt;inodes[$child-&gt;inode]=$child;</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;         static::processChild($child);</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;      }</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;      </div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;      <span class="comment">/*echo &quot;after\n&lt;br/&gt;&quot;;</span></div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="comment">      new dBug($children);</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;<span class="comment">      //var_dump($this-&gt;index);</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="comment">      //var_dump($this-&gt;index-&gt;added);*/</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;      </div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;      <span class="keywordflow">foreach</span>($children as $inode=&gt;$cachedChild){</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;         echo <span class="stringliteral">&quot;file {$cachedChild-&gt;name} ({$cachedChild-&gt;inode}) was deleted\n&lt;br/&gt;\n&quot;</span>;</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;         <span class="comment">//new dBug($cachedChild);</span></div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;         <span class="comment">//$this-&gt;index-&gt;deleted[$inode]=&amp;$cachedChild;//TODO:why does the reference cause terrible errors in logic?</span></div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;         $this-&gt;index-&gt;deleted[$inode]=$cachedChild;</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;      }</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;      echo <span class="stringliteral">&quot;&lt;hr color=&#39;green&#39;/&gt;&quot;</span>;</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;   }</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;   </div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;   </div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;   <span class="keyword">function</span> processChild(<a class="code" href="../../d7/dd4/a00013.html" title="an interface representing a node of file tree with some basic folder functionality such as hashing...">IFileTreeItem</a> &amp;$fChild){</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;      echo <span class="stringliteral">&quot;processing child {$fChild-&gt;name} ({$fChild-&gt;inode}) of {$this-&gt;name} ({$this-&gt;inode})\n&lt;br/&gt;\n&quot;</span>;</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;      </div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;      <span class="comment">/*echo &#39;//var_dump($this-&gt;index-&gt;inodes)&#39;;</span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;<span class="comment">      //var_dump($this-&gt;index-&gt;inodes);</span></div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;<span class="comment">      echo &#39;//var_dump($this-&gt;index)&#39;;</span></div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;<span class="comment">      //var_dump($this-&gt;index);*/</span></div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;      <span class="comment">//drawHierarchy($this-&gt;index-&gt;added);</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;      </div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;      </div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;      $fChild-&gt;process();</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;      echo <span class="stringliteral">&quot;&lt;hr color=&#39;red&#39;/&gt;&quot;</span>;</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;   }</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;   <span class="keyword">function</span> checkDeletedChildren(){</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;      </div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;   }</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;};</div>
<div class="line"><a name="l00438"></a><span class="lineno"><a class="code" href="../../de/d21/a00006.html">  438</a></span>&#160;<span class="keyword">class </span><a class="code" href="../../de/d21/a00006.html" title="a class representing a plugin for backuping file tree takes array of adresses of roots of the backup...">FileTreeBackuper</a> <span class="keyword">implements</span> <a class="code" href="../../d7/dec/a00010.html">IBackuper</a>{</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;   <span class="keyword">public</span> $index, $roots=array();</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;   <span class="keyword">const</span> filesDir=<span class="stringliteral">&quot;files&quot;</span>,patchesDir=<span class="stringliteral">&quot;patches&quot;</span>;</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;   <span class="keyword">public</span> $zip=null;</div>
<div class="line"><a name="l00442"></a><span class="lineno"><a class="code" href="../../de/d21/a00006.html#a828a205eb7aba9ffa8ef35f3b392f60c">  442</a></span>&#160;   <span class="keyword">function</span> <a class="code" href="../../de/d21/a00006.html#a828a205eb7aba9ffa8ef35f3b392f60c" title="initializes backuper plugin with prefs for it">__construct</a>($roots){</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;      $this-&gt;roots=&amp;$roots;</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;   }</div>
<div class="line"><a name="l00445"></a><span class="lineno"><a class="code" href="../../de/d21/a00006.html#a339955e48fe44935ae78e357de76106e">  445</a></span>&#160;   <span class="keyword">function</span> <a class="code" href="../../de/d21/a00006.html#a339955e48fe44935ae78e357de76106e" title="makes opperations needed for backup for example builds graph or looking for modified files takes data...">prepareForBackup</a>(&amp;$base){</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;      $this-&gt;index=<span class="keyword">new</span> <a class="code" href="../../de/d5e/a00007.html">FileTreeBackuperIndex</a>($base);</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;      $roots=array();</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;      <span class="keywordflow">foreach</span>($this-&gt;roots as $root){</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;         echo <span class="stringliteral">&quot;Creating iterator for root: address is $root   .\n&lt;br/&gt;&quot;</span>;</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;         $flags=FilesystemIterator::CURRENT_AS_SELF;</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;         $root=<span class="keyword">new</span> RecursiveDirectoryIterator($root,$flags);</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;         $root-&gt;setFlags($flags|FilesystemIterator::SKIP_DOTS);</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;         echo <span class="stringliteral">&quot;Iterator created: address is &quot;</span>.$root-&gt;getPathname().<span class="stringliteral">&quot;   .\n&lt;br/&gt;&quot;</span>;</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;         $root=<span class="keyword">new</span> <a class="code" href="../../dd/dad/a00005.html" title="a class representing a directory with backup functionality not for direct usage">FileTreeBackupDir</a>($root,$this);</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;         $roots[$root-&gt;inode]=&amp;$root;</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;         $this-&gt;index-&gt;inodes[$root-&gt;inode]=&amp;$root;</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;      }</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;      $this-&gt;roots=&amp;$roots;</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;      <span class="keywordflow">foreach</span>($this-&gt;roots as &amp;$root){</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;         $root-&gt;process();</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;      }</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;      <span class="comment">//drawHierarchy($this-&gt;index-&gt;added);</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;      echo <span class="stringliteral">&quot;&lt;hr color=&#39;purple&#39;/&gt;&quot;</span>;</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;      static::detectMoved();</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;      echo <span class="stringliteral">&quot;&lt;hr color=&#39;magenta&#39;/&gt;&quot;</span>;</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;   }</div>
<div class="line"><a name="l00468"></a><span class="lineno"><a class="code" href="../../de/d21/a00006.html#a44a69a6172a29a78d66c2551a7b51c78">  468</a></span>&#160;   <span class="keyword">function</span> <a class="code" href="../../de/d21/a00006.html#a44a69a6172a29a78d66c2551a7b51c78" title="used to backup all informatin which needs backup">makeBackup</a>(&amp;$arch){</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;      $this-&gt;arch=&amp;$arch;</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;      echo <span class="stringliteral">&quot;archivation of changed...&lt;br/&gt;&quot;</span>;</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;      static::archivateChanged();</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;      echo <span class="stringliteral">&quot;archivating added...&lt;br/&gt;&quot;</span>;</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;      static::archivateAdded();</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;      <span class="comment">//todo: add processing of deleted</span></div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;      </div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;      $this-&gt;index-&gt;save();</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;      <span class="keywordflow">return</span> array(<span class="stringliteral">&#39;comment&#39;</span>=&gt;(<span class="stringliteral">&quot;+ &quot;</span>.count($this-&gt;index-&gt;added)</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;         .<span class="stringliteral">&quot;\n* &quot;</span>.count($this-&gt;index-&gt;changed)</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;         .<span class="stringliteral">&quot;\n-&gt; &quot;</span>.count($this-&gt;index-&gt;moved)</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;         .<span class="stringliteral">&quot;\n- &quot;</span>.count($this-&gt;index-&gt;deleted)));</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;   }</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;   </div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;   </div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;   </div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;   <span class="keyword">private</span> <span class="keyword">function</span> detectMoved(){</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;      echo <span class="stringliteral">&quot;&lt;hr color=&#39;lemonchiffon&#39;/&gt;Detecting moved....&lt;br/&gt;&quot;</span>;</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;      <span class="keywordflow">foreach</span>($this-&gt;index-&gt;deleted as $inode=&gt;&amp;$node){</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;         <span class="comment">//new dBug($node);</span></div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;         <span class="keywordflow">if</span>(isset($this-&gt;index-&gt;added[$inode])){</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;            <span class="comment">//var_dump($this-&gt;index-&gt;inodes[$inode]);</span></div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;            <span class="comment">//var_dump($this-&gt;index-&gt;added[$inode]);</span></div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;            <span class="comment">//var_dump($this-&gt;index-&gt;deleted[$inode]);</span></div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;            <span class="comment">//var_dump($node);</span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;            <span class="keywordflow">if</span>($this-&gt;index-&gt;added[$inode]-&gt;pathhash!=$node-&gt;pathhash){</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;               <span class="comment">//moved</span></div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;               <span class="comment">//var_dump($this-&gt;index-&gt;changed[$node-&gt;parent]);</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;               echo <span class="stringliteral">&quot;file {$node-&gt;name} ({$node-&gt;inode}) was moved\n&lt;br/&gt;\n&quot;</span>;</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;               <span class="comment">//$this-&gt;index-&gt;moved[$node-&gt;inode]=&amp;$node;//TODO:why does the reference cause terrible errors in logic?</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;               $this-&gt;index-&gt;moved[$inode]=$this-&gt;index-&gt;added[$inode];</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;               $this-&gt;index-&gt;moved[$inode]-&gt;prevParent=$this-&gt;index-&gt;deleted[$inode]-&gt;parent;</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;               <span class="comment">//$this-&gt;index-&gt;moved[$inode]-&gt;prevPathhash=$this-&gt;index-&gt;deleted[$inode]-&gt;pathhash;</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;               unset($this-&gt;index-&gt;added[$inode]);</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;               unset($this-&gt;index-&gt;deleted[$inode]);</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;            }<span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;               <span class="comment">//error</span></div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;            }</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;         }</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;      }</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;      <span class="comment">//var_dump($this-&gt;index-&gt;moved);</span></div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;      echo <span class="stringliteral">&quot;&lt;hr color=&#39;lemonchiffon&#39;/&gt;&quot;</span>;</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;   }</div>
<div class="line"><a name="l00512"></a><span class="lineno"><a class="code" href="../../de/d21/a00006.html#a373d45b0bfcbf3a073751f4cddd3f4ff">  512</a></span>&#160;   <span class="keyword">function</span> <a class="code" href="../../de/d21/a00006.html#a373d45b0bfcbf3a073751f4cddd3f4ff" title="determines wheither backup is needed for this plugin">needBackup</a>(){</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;      <span class="keywordflow">return</span> $this-&gt;index-&gt;needBackup();</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;   }</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;   </div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;   <span class="keyword">private</span> <span class="keyword">function</span> archivateAdded(){</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;      <span class="keywordflow">foreach</span>($this-&gt;index-&gt;added as $inode=&gt;&amp;$node){</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;         <span class="comment">//var_dump($this-&gt;index-&gt;inodes[$node-&gt;parent]);</span></div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;         echo <span class="stringliteral">&quot;archivating &quot;</span>.$this-&gt;index-&gt;inodes[$node-&gt;parent]-&gt;path.<span class="charliteral">&#39;/&#39;</span>.$node-&gt;name.</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;         <span class="stringliteral">&#39; as &#39;</span>.static::filesDir.$this-&gt;index-&gt;inodes[$node-&gt;parent]-&gt;relPath.<span class="charliteral">&#39;/&#39;</span>.$node-&gt;name.<span class="stringliteral">&#39;&lt;/br&gt;&#39;</span>;</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;         <span class="keywordflow">if</span>($node instanceof <a class="code" href="../../df/d86/a00012.html" title="an interface representing a folder with some basic folder functionality such as expanding children...">IFileTreeDir</a>){</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;            $this-&gt;arch-&gt;addEmptyDir(static::filesDir.$node-&gt;relPath);</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;         }</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;         <span class="comment">//var_dump($node);</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;         <span class="comment">//var_dump($this-&gt;index-&gt;inodes[$node-&gt;parent]);</span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;            $this-&gt;arch-&gt;addFile(</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;               $this-&gt;index-&gt;inodes[$node-&gt;parent]-&gt;path.<span class="charliteral">&#39;/&#39;</span>.$node-&gt;name,</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;               static::filesDir.$this-&gt;index-&gt;inodes[$node-&gt;parent]-&gt;relPath.<span class="charliteral">&#39;/&#39;</span>.$node-&gt;name</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;            );</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;         </div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;         </div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;      }</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;   }</div>
<div class="line"><a name="l00535"></a><span class="lineno"><a class="code" href="../../de/d21/a00006.html#a1ea80f1ececb5861fd73d829f3631ac2">  535</a></span>&#160;   <span class="keyword">private</span> <span class="keyword">function</span> <a class="code" href="../../de/d21/a00006.html#a1ea80f1ececb5861fd73d829f3631ac2">archivateChanged</a>(){</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;      <span class="keywordflow">foreach</span>($this-&gt;index-&gt;changed as $inode=&gt;&amp;$node){</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;         echo <span class="stringliteral">&quot;archivating &quot;</span>.$this-&gt;index-&gt;inodes[$node-&gt;parent]-&gt;path.<span class="charliteral">&#39;/&#39;</span>.$node-&gt;name.<span class="stringliteral">&#39; as &#39;</span>.static::filesDir.$this-&gt;index-&gt;inodes[$node-&gt;parent]-&gt;relPath.<span class="charliteral">&#39;/&#39;</span>.$node-&gt;name.<span class="stringliteral">&#39;&lt;/br&gt;&#39;</span>;</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;         <span class="keywordflow">if</span>($node instanceof IFileTreeDir){</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;         }</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;         $this-&gt;arch-&gt;addFile(</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;            $this-&gt;index-&gt;inodes[$node-&gt;parent]-&gt;path.<span class="charliteral">&#39;/&#39;</span>.$node-&gt;name,</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;            static::filesDir.$this-&gt;index-&gt;inodes[$node-&gt;parent]-&gt;relPath.<span class="charliteral">&#39;/&#39;</span>.$node-&gt;name);</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;      }</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;   }</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;}</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;?&gt;</div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><b>FileTreeBackuper.php</b></li>
    <li class="footer">Generated on Tue Apr 23 2013 21:25:10 for Backuper by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.3.1-20130402 </li>
  </ul>
</div>
</body>
</html>
